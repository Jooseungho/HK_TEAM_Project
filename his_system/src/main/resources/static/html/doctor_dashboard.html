<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ì‚¬ ì§„ë£Œ ì‹œìŠ¤í…œ</title>

    <!-- ì ‘ê·¼ ê¶Œí•œ / ê³µí†µ í•¨ìˆ˜ -->
    <script src="/js/access.js"></script>
    <script src="/js/app.js"></script>

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            margin: 0;
            background: #f9fafb;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 30px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            font-size: 18px;
            font-weight: 600;
        }

        /* ğŸ”¥ ì˜¤ë¥¸ìª½ ì˜ì—­ (UIë§Œ ì¶”ê°€) */
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* ğŸ”¥ ì‚¬ìš©ì ì´ë¦„ ì˜ì—­ */
        #doctor-name {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
            line-height: 1.3;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }

        .welcome-text {
            font-size: 14px;
            color: #555;
            white-space: nowrap;
        }

        /* ğŸ”¥ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìƒ‰ í†µì¼ */
        .logout-btn {
            padding: 10px 18px;
            border-radius: 12px;
            border: none;
            background: #8ea6ff;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #5d7bff;
        }

        .cards {
            display:flex;
            gap:15px;
            padding:20px 30px;
        }

        .card {
            flex:1;
            background:#eef6ff;
            border-radius:12px;
            padding:20px;
            font-size:16px;
        }

        .card.yellow { background:#fff8dc; }
        .card.green { background:#eafff1; }
        .card.blue { background:#e6f0ff; }

        .card-title { color:#555; margin-bottom:7px; }
        .card-value { font-size:22px; font-weight:700; }

        .tabs {
            display:flex;
            padding:10px 30px 0;
            gap:35px;
            background:white;
            border-bottom:1px solid #d1d5db;
            font-size:17px;
        }

        .tab {
            padding:10px 4px 14px;
            cursor:pointer;
            color:#4b5563;
        }

        .tab.active {
            font-weight:700;
            color:#2563eb;
            border-bottom:3px solid #2563eb;
        }

        #content-area {
            padding:25px 30px;
        }
    </style>
</head>

<body>

<header>
    <div>ì˜ì‚¬ ì§„ë£Œ ì‹œìŠ¤í…œ</div>

    <div class="header-right">
        <div id="doctor-name" class="user-info"></div>
        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>


<script>
    checkAccess(["DOCTOR"]);
</script>

<!-- ìƒë‹¨ ì¹´ë“œ -->
<div class="cards">
    <div class="card yellow">
        <div class="card-title">ëŒ€ê¸° ì¤‘</div>
        <div class="card-value" id="waiting-count">0ëª…</div>
    </div>
    <div class="card blue">
        <div class="card-title">ì§„ë£Œ ì¤‘</div>
        <div class="card-value" id="on-treatment-count">0ëª…</div>
    </div>
    <div class="card green">
        <div class="card-title">ì™„ë£Œ</div>
        <div class="card-value" id="done-count">0ëª…</div>
    </div>
</div>

<!-- íƒ­ -->
<div class="tabs">
    <div class="tab active" data-tab="doctor_waiting">í™˜ì ëŒ€ê¸°ì—´</div>
    <div class="tab" data-tab="doctor_record">ì§„ë£Œ ê¸°ë¡</div>
    <div class="tab" data-tab="doctor_prescription">ì²˜ë°© ê´€ë¦¬</div>
    <div class="tab" data-tab="doctor_document">ë¬¸ì„œ ë°œí–‰</div>
</div>

<div id="content-area"></div>

<script>
/* -------------------------------
   ìƒë‹¨ ì¹´ë“œ ì¹´ìš´íŠ¸
------------------------------- */
async function loadDashboardCounts() {
    const res = await fetch("/api/visit/status_counts");
    if (!res.ok) return;

    const data = await res.json();
    document.getElementById("waiting-count").innerText = `${data.WAITING ?? 0}ëª…`;
    document.getElementById("on-treatment-count").innerText = `${data.IN_TREATMENT ?? 0}ëª…`;
    document.getElementById("done-count").innerText = `${data.DONE ?? 0}ëª…`;
}

/* ------------------------------------
   íƒ­ ì½˜í…ì¸  ë¡œë”© (ì›ë³¸ ë¡œì§ ìœ ì§€)
------------------------------------- */
function loadTabContent(file, extraParam = "") {
    fetch(`/html/${file}.html`)
        .then(res => res.text())
        .then(html => {
            const area = document.getElementById("content-area");
            area.innerHTML = html;

            document.querySelectorAll("script[data-dynamic='yes']").forEach(s => s.remove());

            const scripts = area.querySelectorAll("script");
            scripts.forEach(oldScript => {
                let code = oldScript.innerHTML;

                if (
                    (file === "doctor_record" || file === "doctor_prescription") &&
                    extraParam.startsWith("?visitId=")
                ) {
                    const visitId = extraParam.replace("?visitId=", "");
                    code = `window.visitId=${visitId};\n` + code;
                }

                const newScript = document.createElement("script");
                newScript.setAttribute("data-dynamic", "yes");
                newScript.text = code;
                document.body.appendChild(newScript);
            });
        });
}

/* -------------------------------
   íƒ­ í´ë¦­
------------------------------- */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        const tabName = tab.dataset.tab;
        const currentVisitId = sessionStorage.getItem("currentVisitId");

        if (tabName === "doctor_record" || tabName === "doctor_prescription") {
            if (!currentVisitId) {
                alert("í˜„ì¬ ì„ íƒëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            loadTabContent(tabName, `?visitId=${currentVisitId}`);
        } else {
            loadTabContent(tabName);
        }
    });
});

/* -------------------------------
   ì´ˆê¸° ë¡œë”©
------------------------------- */
window.addEventListener("load", () => {
    loadDashboardCounts();

    const name = localStorage.getItem("name");
    if (name) {
        document.getElementById("doctor-name").innerHTML = `
            <span class="user-name">${name} ë‹˜</span>
            <span class="welcome-text">í™˜ì˜í•©ë‹ˆë‹¤</span>
        `;
    }

    const visitId = sessionStorage.getItem("currentVisitId");

    if (location.hash === "#record" && visitId) {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelector('.tab[data-tab="doctor_record"]').classList.add("active");
        loadTabContent("doctor_record", `?visitId=${visitId}`);
    } else {
        loadTabContent("doctor_waiting");
    }
});
</script>

</body>
</html>
