<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ì‚¬ ì§„ë£Œ ì‹œìŠ¤í…œ</title>

    <!-- ğŸ”¥ ì¶”ê°€: ì ‘ê·¼ ê¶Œí•œ / ì´ë¦„ í‘œì‹œ / ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ -->
    <script src="/js/access.js"></script>
	<script src="/js/app.js"></script>
    

    <style>
        body { font-family: 'Pretendard', sans-serif; margin: 0; background: #f9fafb; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 30px; background: white; border-bottom: 1px solid #e5e7eb;
            font-size: 18px; font-weight: 600;
        }
        .cards { display:flex; gap:15px; padding:20px 30px; }
        .card { flex:1; background:#eef6ff; border-radius:12px; padding:20px; font-size:16px; }
        .card.yellow { background:#fff8dc; }
        .card.green { background:#eafff1; }
        .card.blue { background:#e6f0ff; }
        .card-title { color:#555; margin-bottom:7px; }
        .card-value { font-size:22px; font-weight:700; }

        .tabs { display:flex; padding:10px 30px 0; gap:35px; background:white; border-bottom:1px solid #d1d5db; font-size:17px; }
        .tab { padding:10px 4px 14px; cursor:pointer; color:#4b5563; }
        .tab.active { font-weight:700; color:#2563eb; border-bottom:3px solid #2563eb; }

        #content-area { padding:25px 30px; }
    </style>
</head>

<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        ì˜ì‚¬ ì§„ë£Œ ì‹œìŠ¤í…œ
    </div>

    <!-- ğŸ”¥ ê¸°ì¡´ doctor-name DIV â†’ ë³€ê²½í•˜ì§€ ì•Šê³  ë‚´ë¶€ ê°’ë§Œ JSë¡œ êµì²´ -->
    <div id="doctor-name"></div>

    <!-- ğŸ”¥ ì¶”ê°€: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <button onclick="logout()" 
            style="margin-left:20px; padding:8px 15px; cursor:pointer;">
        ë¡œê·¸ì•„ì›ƒ
    </button>
</header>

<!-- ğŸ”¥ ì¶”ê°€: í˜ì´ì§€ ë¡œë”© ì§í›„ ì ‘ê·¼ ê¶Œí•œ ì²´í¬ -->
<script>
    checkAccess(["DOCTOR"]);
    // ì´ìœ : DOCTOR ì—­í• ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë³´í˜¸
</script>

<!-- ìƒë‹¨ ì¹´ë“œ -->
<div class="cards">
    <div class="card yellow">
        <div class="card-title">ëŒ€ê¸° ì¤‘</div>
        <div class="card-value" id="waiting-count">0ëª…</div>
    </div>
    <div class="card blue">
        <div class="card-title">ì§„ë£Œ ì¤‘</div>
        <div class="card-value" id="on-treatment-count">0ëª…</div>
    </div>
    <div class="card green">
        <div class="card-title">ì™„ë£Œ</div>
        <div class="card-value" id="done-count">0ëª…</div>
    </div>
</div>

<!-- íƒ­ ë©”ë‰´ -->
<div class="tabs">
    <div class="tab active" data-tab="doctor_waiting">í™˜ì ëŒ€ê¸°ì—´</div>
    <div class="tab" data-tab="doctor_record">ì§„ë£Œ ê¸°ë¡</div>
    <div class="tab" data-tab="doctor_prescription">ì²˜ë°© ê´€ë¦¬</div>
    <div class="tab" data-tab="doctor_document">ë¬¸ì„œ ë°œí–‰</div>
</div>

<!-- ì½˜í…ì¸  ì˜ì—­ -->
<div id="content-area"></div>

<script>
/* -------------------------------
    ìƒë‹¨ ì¹´ë“œ ì¹´ìš´íŠ¸ ë¡œë“œ
------------------------------- */
async function loadDashboardCounts() {

    const res = await fetch("/api/visit/status_counts");
    if (!res.ok) return;

    const data = await res.json();


    document.getElementById("waiting-count").innerText =
        `${data.WAITING ?? 0}ëª…`;
    document.getElementById("on-treatment-count").innerText =
        `${data.IN_TREATMENT ?? 0}ëª…`;
    document.getElementById("done-count").innerText =
        `${data.DONE ?? 0}ëª…`;
}

/* ------------------------------------
HTML ë¡œë“œ + ë‚´ë¶€ script ì‹¤í–‰ (ì¤‘ë³µ ì œê±°)
------------------------------------- */
function loadTabContent(file, extraParam = "") {

 fetch(`/html/${file}.html`)
     .then(res => res.text())
     .then(html => {
         const area = document.getElementById("content-area");
         area.innerHTML = html;

         document.querySelectorAll("script[data-dynamic='yes']")
             .forEach(s => s.remove());

         const scripts = area.querySelectorAll("script");

         scripts.forEach(oldScript => {
             let code = oldScript.innerHTML;

             if (
                 (file === "doctor_record" || file === "doctor_prescription") &&
                 extraParam.startsWith("?visitId=")
             ) {
                 const visitId = extraParam.replace("?visitId=", "");
                 code = `window.visitId=${visitId};\n` + code;
             }

             const newScript = document.createElement("script");
             newScript.setAttribute("data-dynamic", "yes");
             newScript.text = code;

             document.body.appendChild(newScript);
         });
     });
}

/* -------------------------------
    íƒ­ í´ë¦­ â†’ í™”ë©´ êµì²´
------------------------------- */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        const tabName = tab.dataset.tab;
        const currentVisitId = sessionStorage.getItem("currentVisitId");

        if (tabName === "doctor_record" || tabName === "doctor_prescription") {
            if (!currentVisitId) {
                alert("í˜„ì¬ ì„ íƒëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            loadTabContent(tabName, `?visitId=${currentVisitId}`);
        } else {
            loadTabContent(tabName);
        }
    });
});

/* ------------------------------------------------
   í˜ì´ì§€ ë¡œë”© ì‹œ
------------------------------------------------ */
window.addEventListener("load", () => {
    loadDashboardCounts();

    const name = localStorage.getItem("name");
    if (name) {
        document.getElementById("doctor-name").innerText = `${name} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;  // ğŸ”¥ ì¶”ê°€
    }

    const visitId = sessionStorage.getItem("currentVisitId");

    if (location.hash === "#record" && visitId) {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelector('.tab[data-tab="doctor_record"]').classList.add("active");
        loadTabContent("doctor_record", `?visitId=${visitId}`);
    } else {
        loadTabContent("doctor_waiting");
    }
});
</script>

</body>
</html>