<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í™˜ì ì ‘ìˆ˜</title>

    <style>
        body { font-family: 'Pretendard', sans-serif; }

        .layout {
            display: flex;
            gap: 25px;
            width: 100%;
        }

        /* LEFT PANEL */
        .left-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .patient-card {
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .patient-card:hover {
            background: #f0fdf4;
            border-color: #4ade80;
        }
        .patient-card.active {
            background: #dcfce7;
            border-color: #22c55e;
        }

        /* RIGHT PANEL */
        .right-panel {
            flex: 1.2;
            background: white;
            padding: 25px;
            border-radius: 12px;
            min-height: 500px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .placeholder {
            text-align: center;
            color: #777;
            margin-top: 120px;
        }
        .placeholder-icon {
            font-size: 70px;
            color: #cbd5e1;
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { font-weight: 600; display: block; margin-bottom: 6px; }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }

        .submit-btn {
            width: 100%;
            background: #22c55e;
            border: none;
            padding: 14px;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>

<body>

<div class="layout">

    <!-- LEFT -->
    <div class="left-panel">
        <h3>í™˜ì ê²€ìƒ‰</h3>

        <input id="search-input" type="text"
               placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì°¨íŠ¸ë²ˆí˜¸ë¡œ ê²€ìƒ‰"
               oninput="filterVisitPatients()"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:20px;">

        <div id="visit-patient-list"></div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel" id="right-panel">
        <div id="placeholder" class="placeholder">
            <div class="placeholder-icon">ğŸ‘¤</div>
            í™˜ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
        </div>

        <div id="register-form" style="display:none;">
            <h2 id="selected-name"></h2>

            <p id="selected-info" style="margin-bottom:25px; color:#444;"></p>

            <div class="form-group">
                <label>í˜ˆì•• *</label>
                <input type="text" id="bp" placeholder="ì˜ˆ: 120/80">
            </div>

            <div class="form-group">
                <label>ë§¥ë°• *</label>
                <input type="number" id="pulse" placeholder="ì˜ˆ: 72">
            </div>

            <div class="form-group">
                <label>ì²´ì˜¨ *</label>
                <input type="number" id="temperature" step="0.1" placeholder="ì˜ˆ: 36.5">
            </div>

            <div class="form-group">
                <label>í˜„ì¬ ì¦ìƒ</label>
                <textarea id="symptom" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label>ë³‘ë ¥ ë° íŠ¹ì´ì‚¬í•­</label>
                <textarea id="history" rows="3"></textarea>
            </div>

            <button class="submit-btn" onclick="submitVisit()">+ ì ‘ìˆ˜ ì™„ë£Œ</button>
        </div>
    </div>
</div>


<script>
let visitPatientAll = [];

/* --------------------------
   í™˜ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
--------------------------- */
function loadVisitPatients() {
    fetch("/api/patient/list")
        .then(res => res.json())
        .then(list => {
            visitPatientAll = list;
            renderVisitPatients(list);
        });
}

/* --------------------------
   í™˜ì ëª©ë¡ ë Œë”ë§
--------------------------- */
function renderVisitPatients(list) {
    const area = document.getElementById("visit-patient-list");
    if (!area) return;

    area.innerHTML = "";

    list.forEach(p => {
        const card = document.createElement("div");
        card.className = "patient-card";

        card.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center;">
                <strong>${p.name}</strong>
                <span style="
                    background:${p.gender === "M" ? "#dbeafe" : "#ffe4e6"};
                    color:${p.gender === "M" ? "#1d4ed8" : "#db2777"};
                    font-size:12px; padding:2px 6px; border-radius:6px;">
                    ${p.gender === "M" ? "ë‚¨" : "ì—¬"}
                </span>
            </div>
            <div style="font-size:14px; margin-top:5px; color:#555;">
                ì°¨íŠ¸ë²ˆí˜¸: ${p.chartNo}<br>
                ìƒë…„ì›”ì¼: ${p.birthdate}<br>
                ì—°ë½ì²˜: ${p.phone}<br>
                ì£¼ì†Œ: ${p.address}
            </div>
        `;

        card.addEventListener("click", () => selectVisitPatient(p, card));

        area.appendChild(card);
    });
}

/* --------------------------
   í™˜ì ì„ íƒ
--------------------------- */
function selectVisitPatient(p, card) {

    document.querySelectorAll(".patient-card").forEach(c => c.classList.remove("active"));
    card.classList.add("active");

    document.getElementById("placeholder").style.display = "none";
    document.getElementById("register-form").style.display = "block";

    document.getElementById("selected-name").innerText = p.name;
    document.getElementById("selected-info").innerHTML = `
        ì°¨íŠ¸ë²ˆí˜¸: ${p.chartNo}<br>
        ìƒë…„ì›”ì¼: ${p.birthdate}
    `;

    window.selectedVisitPatient = p;
}

/* --------------------------
   ê²€ìƒ‰ í•„í„°
--------------------------- */
function filterVisitPatients() {
    const keyword = document.getElementById("search-input").value.trim();

    // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ì¶œë ¥
    if (keyword === "") {
        renderVisitPatients(visitPatientAll);
        return;
    }

    const filtered = visitPatientAll.filter(p =>
        p.name.includes(keyword) ||
        p.chartNo.toLowerCase().includes(keyword.toLowerCase()) ||
        p.phone.replace(/-/g, "").includes(keyword.replace(/-/g, ""))
    );

    renderVisitPatients(filtered);
}
async function submitVisit() {
    if (!window.selectedVisitPatient) {
        alert("í™˜ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    const bp = document.getElementById("bp").value.trim();
    const pulse = document.getElementById("pulse").value.trim();
    const temperature = document.getElementById("temperature").value.trim();
    const symptom = document.getElementById("symptom").value.trim();
    const history = document.getElementById("history").value.trim();

    // -----------------------------
    // 1) í•„ìˆ˜ê°’ ê²€ì¦
    // -----------------------------
    if (!bp || !pulse || !temperature) {
        alert("í•„ìˆ˜ í•­ëª©(í˜ˆì••/ë§¥ë°•/ì²´ì˜¨)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    // BP ì…ë ¥ ê²€ì¦
    if (!bp.includes("/")) {
        alert("í˜ˆì••ì€ '120/80' í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    // -----------------------------
    // 2) BP íŒŒì‹±
    // -----------------------------
    const [sysStr, diaStr] = bp.split("/").map(v => v.trim());
    const bpSystolic = parseInt(sysStr);
    const bpDiastolic = parseInt(diaStr);

    if (isNaN(bpSystolic) || isNaN(bpDiastolic)) {
        alert("í˜ˆì•• í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆ: 120/80");
        return;
    }

    // -----------------------------
    // 3) ì„œë²„ ì „ì†¡ ë°ì´í„° êµ¬ì„±
    // -----------------------------
    const requestBody = {
        patientId: window.selectedVisitPatient.id,
        nurseId: 1,                          // ë¡œê·¸ì¸ ì—°ë™ ì „ê¹Œì§€ 1 ê³ ì •
        bpSystolic,
        bpDiastolic,
        heartRate: parseInt(pulse),
        temperature: parseFloat(temperature),
        memo: (symptom + "\n" + history).trim(),

        // í•„ìš” ì‹œ í™•ì¥ ê°€ëŠ¥ (ì§€ê¸ˆì€ null ì €ì¥ë¨)
        respiration: null,
        spo2: null
    };

    console.log("ğŸ“¡ ì „ì†¡ ë°ì´í„°:", requestBody);

    // -----------------------------
    // 4) ì„œë²„ ìš”ì²­ + Vital ì™„ì„±ë  ë•Œê¹Œì§€ ì ê¹ ê¸°ë‹¤ë¦¬ê¸°
    // -----------------------------
    try {
        const response = await fetch("/api/visit/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            alert("ì €ì¥ ì‹¤íŒ¨: " + await response.text());
            return;
        }

        // -----------------------------
        // 5) íŠ¸ëœì­ì…˜ ì™„ë£Œ ëŒ€ê¸° (Vital â†’ DB ë°˜ì˜ ì‹œê°„ í™•ë³´)
        // -----------------------------
        await new Promise(r => setTimeout(r, 350));

        alert("ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");

        // ì´ì œ reload í•˜ë”ë¼ë„ Vital ì •ë³´ê°€ ì™„ì „íˆ ë°˜ì˜ë¨
        location.reload();

    } catch (err) {
        console.error(err);
        alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
    }
}


function initVisitRegisterPage() {
    loadPatients();
    loadReceptionList();
    loadWaitingList();
}



/* ì²« ë¡œë”© */
loadVisitPatients();
</script>

</body>
</html>
