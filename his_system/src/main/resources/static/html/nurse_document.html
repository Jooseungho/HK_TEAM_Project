<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ë¬¸ì„œ ì¡°íšŒ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ===== ê¸°ë³¸ ë¦¬ì…‹ & ê³µí†µ ===== */
* {
	box-sizing: border-box;
	margin: 0;
	padding: 0;
}

body {
	font-family: 'Noto Sans KR', sans-serif;
	background-color: #f5f7fb;
	color: #111827;
}

a {
	text-decoration: none;
	color: inherit;
}

button {
	font-family: inherit;
	border: none;
	background: none;
	cursor: pointer;
}

/* ===== í˜ì´ì§€ ì „ì²´ë¥¼ ê½‰ ì±„ìš°ë„ë¡ ë³€ê²½ë¨ ===== */
.page {
	width: 100%;
	padding: 0 40px 48px;
	margin-top: 32px;
}

/* ===== ì¹´ë“œ ê³µí†µ (ê°ì§„ ëŠë‚Œ) ===== */
.card {
	background-color: #ffffff;
	border-radius: 8px; /* ë‘¥ê·¼ ì •ë„ ê°ì†Œ */
	border: 1px solid #e5e7eb;
	box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05); /* shadow-sm ëŠë‚Œ */
	padding: 24px 28px;
	width: 100%;
}

.card-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 0; /* ìƒë‹¨ ë°•ìŠ¤ì—ì„œ ì‚¬ìš© */
}

.card-title {
	font-size: 18px;
	font-weight: 600;
}

.card-subtitle {
	font-size: 13px;
	color: #6b7280;
	margin-top: 4px;
}

/* ===== grid â†’ í™”ë©´ ê½‰ ì±„ì›Œì„œ í™•ì¥ ===== */
.grid-2 {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 24px;
	margin-top: 24px;
	width: 100%;
}

.grid-main {
	display: grid;
	grid-template-columns: 0.7fr 1.3fr;
	gap: 24px;
	margin-top: 24px;
	width: 100%;
}

/* ===== ìƒë‹¨ "ë¬¸ì„œ ê´€ë¦¬" ì˜ì—­ (ìš”ì²­ ì‚¬í•­ ë°˜ì˜) ===== */
.doc-manage-box {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

/* ìš”ì²­í•˜ê¸° ë²„íŠ¼ (ê°ì§„ ëª¨ì–‘, ë¬¸ì„œ ê´€ë¦¬ ë°•ìŠ¤ ì•ˆì— í¬í•¨) */
.doc-manage-button {
	width: 200px; /* í¬ê¸° ì¡°ì • */
	padding: 10px 18px;
	border-radius: 6px; /* ë‘¥ê·¼ ì •ë„ ê°ì†Œ */
	background-color: #2563eb;
	font-size: 14px;
	font-weight: 600;
	color: #ffffff;
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 6px;
}

/* ===== ìš”ì²­ ëŒ€ê¸° / ìµœê·¼ ë°œí–‰ ===== */
.badge-round {
	padding: 4px 10px;
	border-radius: 999px;
	font-size: 12px;
	font-weight: 600;
}

.badge-yellow {
	background: #fef3c7;
	color: #92400e;
}

.badge-green-soft {
	background: #dcfce7;
	color: #166534;
}

.status-title {
	font-size: 16px;
	font-weight: 600;
	margin-bottom: 4px;
}

.status-count {
	font-size: 13px;
	color: #6b7280;
	margin-bottom: 8px;
}

/* íƒ€ì´í‹€ ì•„ë˜ êµ¬ë¶„ì„  */
.with-line {
	padding-bottom: 10px;
	border-bottom: 1px solid #e5e7eb;
	margin-bottom: 18px;
}

.status-empty {
	text-align: center;
	padding: 36px 0;
	color: #9ca3af;
	font-size: 14px;
}

.status-empty-icon {
	font-size: 36px;
	margin-bottom: 12px;
}

.recent-row {
	display: flex;
	justify-content: space-between;
	margin-top: 16px;
}

.recent-patient {
	font-weight: 600;
	font-size: 15px;
}

.recent-chart {
	padding: 2px 8px;
	border-radius: 4px; /* ë‘¥ê·¼ ì •ë„ ê°ì†Œ */
	background: #f3f4f6;
	font-size: 11px;
	margin-left: 6px;
	color: #4b5563; /* ì§™ì€ íšŒìƒ‰ */
}

/* ì²˜ë°©ì „/ì§„ë£Œí™•ì¸ì„œ íƒœê·¸ ( */
.pill-type {
	display: inline-block;
	padding: 4px 10px;
	border-radius: 9px;
	font-size: 12px;
	font-weight: 600;
	background-color: #e0edff; /* ì²˜ë°©ì „ ìƒ‰ */
	color: #1d4ed8;
	width: auto;
}

.btn-primary-outline {
	padding: 8px 18px;
	border-radius: 6px; /* ê°ì§„ ëŠë‚Œ */
	border: 1px solid #16a34a;
	background-color: #16a34a;
	color: white;
	font-size: 13px;
	font-weight: 600;
}

/* ===== ë¬¸ì„œ ëª©ë¡ (ìš”ì²­ ì‚¬í•­ ë°˜ì˜: ì œëª©ê³¼ ëª©ë¡ ê°„ê²© ì¡°ì •) ===== */
.doc-list-area {
	margin-top: 18px; /* ì œëª©ê³¼ ëª©ë¡ ê°„ê²© ì¡°ì • */
	border: 1px solid #e5e7eb;
	border-radius: 8px;
	overflow: hidden;
}

.doc-row {
	padding: 14px 18px;
	border-bottom: 1px solid #eef2f7;
	cursor: pointer;
	background: transparent !important;
	display: flex;
	flex-direction: column;
}

.doc-row.active {
	background: #edf2ff;
}

.doc-row>div {
	margin-top: 6px;
} /* ê°„ê²© ì¡°ì • */

/* ===== ë¯¸ë¦¬ë³´ê¸° (ì¶œë ¥/ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ê°€ë¡œ ë°°ì¹˜ ë° ì•„ì´ì½˜ ìˆ˜ì •) ===== */
.preview-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 18px;
}

.preview-actions {
	display: flex;
	gap: 8px; /* ë²„íŠ¼ ê°„ ê°„ê²© */
}

/* ì¶œë ¥ ë²„íŠ¼ (ì•„ì´ì½˜ í¬í•¨, ê°ì§„ ëŠë‚Œ) */
.btn-green-preview {
	padding: 9px 15px;
	border-radius: 6px;
	background: #16a34a;
	color: white;
	display: flex;
	align-items: center;
	gap: 6px;
	font-size: 14px;
}

/* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì•„ì´ì½˜ í¬í•¨, ê°ì§„ ëŠë‚Œ) */
.btn-white-outline-preview {
	padding: 9px 15px;
	border-radius: 6px;
	background: white;
	border: 1px solid #d1d5db;
	color: #374151;
	display: flex;
	align-items: center;
	gap: 6px;
	font-size: 14px;
}

.preview-inner {
	border: 1px solid #e5e7eb;
	padding: 28px 40px;
	border-radius: 8px;
	background: white;
}

/* ===== ë°˜ì‘í˜• ===== */
@media ( max-width :1024px) {
	.grid-2, .grid-main {
		grid-template-columns: 1fr;
	}
	.doc-manage-button {
		width: 100%;
	}
}
</style>
</head>

<body>
	<div class="page">

		<div class="card">
			<div class="doc-manage-box">
				<div>
					<div class="card-title">ë¬¸ì„œ ê´€ë¦¬</div>
				</div>
				<button class="doc-manage-button">
					<i class="fas fa-plus"></i> ì˜ì‚¬ì—ê²Œ ë¬¸ì„œ ìš”ì²­í•˜ê¸°
				</button>
			</div>
		</div>

		<div class="grid-2">

			<div class="card">
				<div class="with-line">
					<div class="status-title">ìš”ì²­ ëŒ€ê¸° ì¤‘</div>
					<div class="status-count">0ê±´</div>
				</div>
				<div class="status-empty">
					<div class="status-empty-icon">
						<i class="far fa-file-alt"></i>
					</div>
					ìš”ì²­ ëŒ€ê¸° ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤
				</div>
			</div>

			<div class="card">
				<div class="with-line">
					<div class="status-title">ìµœê·¼ ë°œí–‰ ì™„ë£Œ</div>
					<div class="status-count">1ê±´</div>
				</div>

				<div class="recent-row">
					<div>
						<div class="recent-patient">
							í™ê¸¸ë™ <span class="recent-chart">C2024001</span>
						</div>
						<span class="pill-type">ì²˜ë°©ì „</span>
						<div style="margin-top: 4px; font-size: 12px; color: #6b7280;">ë°œí–‰:
							2025. 11. 28. ì˜¤ì „ 10:30</div>
					</div>
				</div>
			</div>
		</div>

		<div class="grid-main">

			<div class="card">
				<div class="card-title">ë°œí–‰ëœ ë¬¸ì„œ ëª©ë¡</div>
				<div class="doc-list-area">
					<!-- <div class="doc-row active">
						<span class="pill-type">ì²˜ë°©ì „</span>
						<div>í™˜ì ID: P001</div>
						<div style="font-size: 12px; color: #6b7280;">ë°œí–‰: ê¹€ì˜ì‚¬ Â·
							2025. 11. 20. ì˜¤í›„ 3:00</div>
					</div>
					<div class="doc-row">
						<span class="pill-type"
							style="background: #dcfce7; color: #065f46;">ì§„ë£Œí™•ì¸ì„œ</span>
						<div>í™˜ì ID: P002</div>
						<div style="font-size: 12px; color: #6b7280;">ë°œí–‰: ë°•ì˜ì‚¬ Â·
							2025. 11. 15. ì˜¤í›„ 10:30</div>
					</div> -->
				</div>
			</div>

			<div class="card preview-card">
				<div class="preview-header">
					<div class="card-title">ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸°</div>

					<div class="preview-actions">
						<button class="btn-green-preview">
							<i class="fas fa-print"></i> ì¶œë ¥
						</button>
						<button class="btn-white-outline-preview">
							<i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
						</button>
					</div>
				</div>

				<div class="preview-inner">
					<h2 style="text-align: center;">ì²˜ë°©ì „</h2>

					<div
						style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 30px; margin-bottom: 20px;">
						<p>
							<strong>í™˜ì ID:</strong> P001
						</p>
						<p>
							<strong>ì§„ë£Œ ê¸°ë¡ ID:</strong> MR001
						</p>
						<p>
							<strong>ë°œí–‰ì:</strong> ê¹€ì˜ì‚¬
						</p>
						<p>
							<strong>ë°œí–‰ì¼ì‹œ:</strong> 2025. 11. 20. ì˜¤í›„ 3:00
						</p>
					</div>

					<div
						style="margin-top: 20px; background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
						<div style="font-weight: 600; margin-bottom: 10px;">ë¬¸ì„œ ë‚´ìš©</div>
						<div style="font-size: 14px; color: #374151;">íƒ€ì´ë ˆë†€ 500mg 1ì¼
							3íšŒ 7ì¼ë¶„</div>
						<br>
						<div style="font-size: 14px; color: #374151;">ìƒê¸° í™˜ìì—ê²Œ ìœ„ì™€ ê°™ì´
							ì²˜ë°©í•©ë‹ˆë‹¤.</div>
					</div>

					<div
						style="text-align: right; margin-top: 40px; font-size: 14px; color: #4b5563;">
						<p style="font-weight: 600; color: #111827;">ë°œí–‰: ê¹€ì˜ì‚¬</p>
						<p>2025. 11. 20.</p>
					</div>

				</div>
			</div>

		</div>
	</div>

	<script>

	const nurseId = sessionStorage.getItem("loginStaffId");

	document.querySelector(".doc-manage-button")
	  .addEventListener("click", () => {

	    if (!nurseId) {
	      alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
	      return;
	    }

	    const docType = prompt(
	      "ìš”ì²­í•  ë¬¸ì„œ ì¢…ë¥˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”\n(PRESCRIPTION / CERTIFICATION / OPINION)"
	    );

	    if (!docType) return;

	    fetch(`/api/document-request?nurseId=${nurseId}&docType=${docType}`, {
	      method: "POST"
	    })
	    .then(res => {
	      if (!res.ok) throw new Error();
	      return res.json();
	    })
	    .then(() => {
	      alert("ì˜ì‚¬ì—ê²Œ ë¬¸ì„œ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
	      loadRequestedList();
	    })
	    .catch(() => {
	      alert("ë¬¸ì„œ ìš”ì²­ ì‹¤íŒ¨");
	    });
	});
function loadRequestedList() {
	  fetch("/api/document-request/requested")
	    .then(res => res.json())
	    .then(list => {
	      const container = document.querySelector(".card .status-empty");
	      const count = document.querySelector(".status-count");

	      count.innerText = `${list.length}ê±´`;

	      if (list.length === 0) {
	        container.innerHTML = `
	          <div class="status-empty-icon"><i class="far fa-file-alt"></i></div>
	          ìš”ì²­ ëŒ€ê¸° ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤
	        `;
	        return;
	      }

	      container.innerHTML = list.map(r => `
	        <div style="text-align:left; margin-bottom:12px;">
	          <div><strong>${r.visit.patient.name}</strong></div>
	          <div style="font-size:12px; color:#6b7280;">
	            ${r.docType} Â· ìš”ì²­ ${r.requestedAt.replace('T',' ')}
	          </div>
	        </div>
	      `).join("");
	    });
	}

function loadSentDocuments() {
	  fetch("/api/document-request/sent")
	    .then(res => res.json())
	    .then(list => {
	      const area = document.querySelector(".doc-list-area");
	      area.innerHTML = "";

	      if (list.length === 0) {
	        area.innerHTML =
	          "<div style='padding:16px;color:#9ca3af'>ë°œí–‰ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>";
	        return;
	      }

	      list.forEach((r, idx) => {
	        const row = document.createElement("div");
	        row.className = "doc-row";
	        if (idx === 0) row.classList.add("active");

	        row.innerHTML = `
	          <span class="pill-type">${r.docType}</span>
	          <div style="font-size:12px;color:#6b7280;">
	            ë°œí–‰ ìš”ì²­ ì‹œê°„: ${r.requestedAt.replace('T',' ')}
	          </div>
	        `;

	        // ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸°ëŠ” requestId ê¸°ì¤€ìœ¼ë¡œ
	        row.onclick = () => loadPreviewByRequest(r.requestId);

	        area.appendChild(row);
	      });
	    });
	}

	
function loadPreview(visitId, docType, requestId) {

	  fetch(`/api/document/visit/${visitId}`)
	    .then(res => res.json())
	    .then(list => {

	      // ê°™ì€ visit ì•ˆì—ì„œ docType ë§ëŠ” ë¬¸ì„œ ì°¾ê¸°
	      const doc = list.find(d => d.docType === docType);
	      if (!doc) {
	        alert("ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	        return;
	      }

	      const preview = document.querySelector(".preview-inner");

	      preview.innerHTML = `
	        <h2 style="text-align:center;">${doc.docType}</h2>

	        <div style="margin-top:20px;">
	          ${doc.contentHtml}
	        </div>
	      `;

	      // ğŸ”¥ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì— requestId ì €ì¥
	      document
	        .querySelector(".btn-white-outline-preview")
	        .setAttribute("data-request-id", requestId);
	    });
	}
	
function loadPreviewByRequest(requestId) {
	  fetch(`/api/document/request/${requestId}`)
	    .then(res => res.json())
	    .then(doc => {
	      const preview = document.querySelector(".preview-inner");

	      preview.innerHTML = `
	        <h2 style="text-align:center;">${doc.docType}</h2>
	        <div style="margin-top:20px;">
	          ${doc.contentHtml}
	        </div>
	      `;
	    });
	}
	
	
document
.querySelector(".btn-white-outline-preview")
.addEventListener("click", () => {

  const btn = document.querySelector(".btn-white-outline-preview");
  const requestId = btn.getAttribute("data-request-id");

  if (!requestId) {
    alert("ì„ íƒëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // âœ… ìƒíƒœ COMPLETED ì²˜ë¦¬
  fetch(`/api/document-request/${requestId}/complete`, {
    method: "PATCH"
  })
  .then(() => {
    alert("ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");

    // ğŸ”„ ëª©ë¡ ê°±ì‹ 
    loadSentDocuments();      // ë°œí–‰ëœ ë¬¸ì„œ ëª©ë¡
    loadCompletedList();      // ìµœê·¼ ë°œí–‰ ì™„ë£Œ
  })
  .catch(err => {
    console.error(err);
    alert("ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ ì‹¤íŒ¨");
  });
});

function loadCompletedList() {
	  fetch("/api/document-request/completed")
	    .then(res => res.json())
	    .then(list => {

	      const container = document.querySelector(".recent-row");
	      container.innerHTML = "";

	      if (list.length === 0) {
	        container.innerHTML = `
	          <div style="color:#9ca3af;font-size:14px;">
	            ìµœê·¼ ë°œí–‰ ì™„ë£Œ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤
	          </div>
	        `;
	        return;
	      }

	      list.forEach(r => {
	        container.innerHTML += `
	          <div>
	            <div class="recent-patient">
	              ${r.visit.patient.name}
	              <span class="recent-chart">${r.visit.patient.chartNo}</span>
	            </div>
	            <span class="pill-type">${r.docType}</span>
	            <div style="font-size:12px;color:#6b7280;margin-top:4px;">
	              ì™„ë£Œ: ${r.requestedAt.replace('T',' ')}
	            </div>
	          </div>
	        `;
	      });
	    });
	}

	// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
	loadCompletedList();
</script>

</body>
</html>