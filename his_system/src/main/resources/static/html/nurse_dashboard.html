<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°„í˜¸ì‚¬ ì—…ë¬´ ì‹œìŠ¤í…œ</title>

    <!-- ì ‘ê·¼ ê¶Œí•œ / ê³µí†µ í•¨ìˆ˜ -->
    <script src="/js/access.js"></script>
    <script src="/js/app.js"></script>

    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

<header>
    <div>ê°„í˜¸ì‚¬ ì—…ë¬´ ì‹œìŠ¤í…œ</div>

    <div class="header-right">
        <div id="nurse-name" class="user-info"></div>
        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<!-- ê¶Œí•œ ì²´í¬ -->
<script>
    checkAccess(["NURSE"]);
</script>

<!-- =========================
     ìƒë‹¨ ì¹´ë“œ (ğŸ”¥ ìˆ˜ì • í•µì‹¬)
========================= -->
<div class="cards">
    <div class="card total">
        <div class="card-title">ì´ ì ‘ìˆ˜</div>
        <div class="card-value" id="total-count">0ëª…</div>
    </div>

    <div class="card waiting">
        <div class="card-title">ëŒ€ê¸° ì¤‘</div>
        <div class="card-value" id="waiting-count">0ëª…</div>
    </div>

    <div class="card done">
        <div class="card-title">ì§„ë£Œ ì™„ë£Œ</div>
        <div class="card-value" id="done-count">0ëª…</div>
    </div>

    <div class="card patient">
        <div class="card-title">ë“±ë¡ í™˜ì</div>
        <div class="card-value" id="patient-count">0ëª…</div>
    </div>
</div>

<!-- =========================
     íƒ­
========================= -->
<div class="tabs">
    <div class="tab active" data-tab="patient_register">í™˜ì ë“±ë¡</div>
    <div class="tab" data-tab="visit_register">í™˜ì ì ‘ìˆ˜</div>
    <div class="tab" data-tab="nurse_treatment">ì²˜ì¹˜ ê´€ë¦¬</div>
    <div class="tab" data-tab="nurse_bill">ìˆ˜ë‚© ì²˜ë¦¬</div>
    <div class="tab" data-tab="nurse_document">ë¬¸ì„œ ì¡°íšŒ</div>
</div>

<!-- ì½˜í…ì¸  -->
<div id="content-area"></div>

<script>
/* =========================
   íƒ­ í´ë¦­
========================= */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        loadTabContent(tab.dataset.tab);
    });
});

/* =========================
   íƒ­ ì½˜í…ì¸  ë¡œë”©
========================= */
function loadTabContent(file) {
    fetch(`/html/${file}.html`)
        .then(res => res.text())
        .then(html => {
            const contentArea = document.getElementById("content-area");
            contentArea.innerHTML = html;

            const scripts = contentArea.querySelectorAll("script");
            scripts.forEach(scriptTag => {
                const scriptId = scriptTag.dataset.scriptId;
                if (scriptId && document.querySelector(`script[data-loaded-id="${scriptId}"]`)) {
                    scriptTag.remove();
                    return;
                }

                const newScript = document.createElement("script");
                if (scriptId) newScript.dataset.loadedId = scriptId;
                newScript.text = scriptTag.innerHTML;
                document.body.appendChild(newScript);
                scriptTag.remove();
            });

            if (file === "nurse_document") {
                if (typeof loadRequested === "function") {
                    loadRequested();
                    loadCompleted();
                    loadSent();
                }
            }

            if (file === "patient_register" && typeof loadPatientRegisterList === "function") {
                loadPatientRegisterList();
            }
            if (file === "visit_register" && typeof initVisitRegisterPage === "function") {
                initVisitRegisterPage();
            }
        });
}

/* =========================
   ìƒë‹¨ ì¹´ë“œ ì¹´ìš´íŠ¸
========================= */
async function loadNurseDashboardCounts() {
    const res = await fetch("/api/visit/status_counts");
    if (!res.ok) return;

    const data = await res.json();
    const total = (data.WAITING ?? 0) + (data.IN_TREATMENT ?? 0) + (data.DONE ?? 0);

    document.getElementById("total-count").innerText = `${total}ëª…`;
    document.getElementById("waiting-count").innerText = `${data.WAITING ?? 0}ëª…`;
    document.getElementById("done-count").innerText = `${data.DONE ?? 0}ëª…`;
}

/* ì´ˆê¸° ë¡œë”© */
loadTabContent("patient_register");
loadNurseDashboardCounts();

/* =========================
   ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
========================= */
window.addEventListener("load", () => {
    const name = localStorage.getItem("name");
    if (name) {
        document.getElementById("nurse-name").innerHTML = `
            <span class="user-name">${name} ë‹˜</span>
            <span class="welcome-text">í™˜ì˜í•©ë‹ˆë‹¤</span>
        `;
    }
});

/* ì „ì—­ í•¨ìˆ˜ */
window.openPatientRegister = function () {
    loadTabContent("patient_register_form");
};
</script>

</body>
</html>
