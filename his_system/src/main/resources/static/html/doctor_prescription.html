<h2 style="font-size: 26px; font-weight: 700; margin-bottom: 15px;">ì²˜ë°©
	ê´€ë¦¬</h2>

<!-- ğŸ”µ í˜„ì¬ ì§„ë£Œ ì¤‘ í™˜ì ì •ë³´ -->
<div id="patient-info-box"
	style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 25px;">
	í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

<!-- -------------------------------
      ì•½ë¬¼ ì²˜ë°© ì…ë ¥ í¼
-------------------------------- -->
<div
	style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
	<h3 style="margin-bottom: 20px;">ğŸ’Š ì•½ë¬¼ ì²˜ë°©</h3>

	<div class="form-row">
		<div style="flex: 1;">
			<label>ì•½í’ˆëª…</label> <select id="drugName"
				style="width: 100%; padding: 10px;">
				<option value="">ì„ íƒí•˜ì„¸ìš”</option>
				<option value="íƒ€ì´ë ˆë†€ 500mg">íƒ€ì´ë ˆë†€ 500mg</option>
				<option value="í•´ì—´ì œ">í•´ì—´ì œ</option>
				<option value="ì§„í•´ê±°ë‹´ì œ">ì§„í•´ê±°ë‹´ì œ</option>
			</select>
		</div>

		<div style="flex: 1;">
			<label>ìš©ëŸ‰</label> <input id="dosage" placeholder="ì˜ˆ: 500mg"
				style="width: 100%; padding: 10px;">
		</div>
	</div>

	<div class="form-row" style="margin-top: 15px;">
		<div style="flex: 1;">
			<label>íˆ¬ì•½ íšŸìˆ˜</label> <select id="doseCount"
				style="width: 100%; padding: 10px;">
				<option value="1ì¼ 1íšŒ">1ì¼ 1íšŒ</option>
				<option value="1ì¼ 2íšŒ">1ì¼ 2íšŒ</option>
				<option value="1ì¼ 3íšŒ">1ì¼ 3íšŒ</option>
			</select>
		</div>

		<div style="flex: 1;">
			<label>íˆ¬ì•½ ê¸°ê°„</label> <select id="doseDays"
				style="width: 100%; padding: 10px;">
				<option value="3">3ì¼</option>
				<option value="5">5ì¼</option>
				<option value="7">7ì¼</option>
			</select>
		</div>

		<div style="flex: 1;">
			<label>ì´ íˆ¬ì•½ëŸ‰</label> <input id="totalAmount" disabled
				style="width: 100%; padding: 10px;">
		</div>
	</div>

	<button onclick="addDrug()"
		style="margin-top: 15px; padding: 12px; width: 100%; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer;">
		+ ì•½ë¬¼ ì¶”ê°€</button>

	<div id="drug-list"
		style="margin-top: 15px; background: #f8fafc; padding: 15px; border-radius: 8px;">
		ì•½ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<!-- -------------------------------
      ì£¼ì‚¬ / ì²˜ì¹˜ ì…ë ¥ í¼
-------------------------------- -->
<div
	style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
	<h3 style="margin-bottom: 20px;">ğŸ’‰ ì£¼ì‚¬ ë° ì²˜ì¹˜</h3>

	<div class="form-row">
		<div style="flex: 1;">
			<label>ì²˜ì¹˜ ìœ í˜•</label> <select id="treatType"
				style="width: 100%; padding: 10px;">
				<option value="INJECTION">ì£¼ì‚¬</option>
				<option value="PROCEDURE">ì²˜ì¹˜</option>
			</select>
		</div>

		<div style="flex: 1;">
			<label>ì²˜ì¹˜ëª…</label> <input id="treatName"
				placeholder="ì˜ˆ: X-ray ì´¬ì˜, ë¹„íƒ€ë¯¼ ì£¼ì‚¬"
				style="width: 100%; padding: 10px;">
		</div>
	</div>

	<div style="margin-top: 15px;">
		<label>íŠ¹ì´ì‚¬í•­</label>
		<textarea id="treatMemo" rows="2" style="width: 100%; padding: 10px;"></textarea>
	</div>

	<button onclick="addTreatment()"
		style="margin-top: 15px; padding: 12px; width: 100%; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer;">
		+ ì²˜ì¹˜ ì¶”ê°€</button>

	<div id="treatment-list"
		style="margin-top: 15px; background: #f8fafc; padding: 15px; border-radius: 8px;">
		ì²˜ì¹˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<!-- -------------------------------
        ì „ì²´ ì €ì¥ ë²„íŠ¼
-------------------------------- -->
<button onclick="saveAll()"
	style="width: 100%; padding: 14px; background: #2563eb; color: white; border: none; border-radius: 10px; font-size: 18px; cursor: pointer;">
	ì²˜ë°© ì €ì¥ ë° ê°„í˜¸ì‚¬ì—ê²Œ ì „ë‹¬</button>

<script>
let drugList = [];
let treatmentList = [];

/* ---------------------------
   ğŸ”µ í™˜ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
--------------------------- */
async function loadPatientInfo() {
    const visitId = sessionStorage.getItem("currentVisitId");
    if (!visitId) return;

    const res = await fetch(`/api/visit/${visitId}/detail`);
    if (!res.ok) {
        document.getElementById("patient-info-box").innerText = "í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        return;
    }

    const data = await res.json();
    const p = data.patient;
    const v = data.vital || {};

    document.getElementById("patient-info-box").innerHTML = `
        <div style="font-size:20px; font-weight:700; margin-bottom:10px;">
            ${p.name} &nbsp; <span style="color:#6b7280;">(${p.chartNo})</span>
        </div>

        <div style="color:#444; margin-bottom:8px;">
            ìƒë…„ì›”ì¼: ${p.birthdate} | ì—°ë½ì²˜: ${p.phone}
        </div>

        <div style="
            background:#f8fafc; padding:15px; border-radius:10px;
            margin-top:12px; display:flex; gap:40px;
        ">
            <div><b>í˜ˆì••</b><br>${v.bpSystolic ?? "-"} / ${v.bpDiastolic ?? "-"}</div>
            <div><b>ë§¥ë°•</b><br>${v.heartRate ?? "-"} bpm</div>
            <div><b>ì²´ì˜¨</b><br>${v.temperature ?? "-"}â„ƒ</div>
            <div><b>ì¦ìƒ</b><br>${v.memo ?? "-"}</div>
        </div>
    `;
}

/* ---------------------------
   ğŸ’Š ì•½ë¬¼ ì¶”ê°€ / ë Œë”ë§
--------------------------- */
function addDrug() {
    const name = document.getElementById("drugName").value.trim();
    const dosage = document.getElementById("dosage").value.trim();
    const doseCount = document.getElementById("doseCount").value;
    const doseDays = parseInt(document.getElementById("doseDays").value);

    if (!name || !dosage) {
        alert("ì•½í’ˆëª…ê³¼ ìš©ëŸ‰ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        return;
    }

    const cnt = parseInt(doseCount.replace(/[^0-9]/g, ""));
    const total = cnt * doseDays;

    const item = { name, dosage, doseCount, doseDays, total };
    drugList.push(item);
    renderDrugList();
}

function renderDrugList() {
    const area = document.getElementById("drug-list");

    if (drugList.length === 0) {
        area.innerHTML = "ì•½ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    area.innerHTML = "";
    drugList.forEach((d, idx) => {
        area.innerHTML += `
            <div style="padding:10px; background:white; border-radius:8px; margin-bottom:10px;">
                <strong>${d.name}</strong> (${d.dosage})<br>
                íˆ¬ì•½: ${d.doseCount} / ê¸°ê°„: ${d.doseDays}ì¼<br>
                <span style="color:#2563eb;">ì´ ${d.total}íšŒ íˆ¬ì•½</span>
                <button onclick="deleteDrug(${idx})"
                    style="float:right; margin-top:-25px; padding:4px 10px;
                           background:#ef4444; color:white; border:none;
                           border-radius:6px; cursor:pointer;">
                    ì‚­ì œ
                </button>
            </div>
        `;
    });
}

function deleteDrug(idx) {
    drugList.splice(idx, 1);
    renderDrugList();
}
async function loadDrugStatus() {
    const res = await fetch("/api/drug/status");
    const list = await res.json();

    const area = document.getElementById("drug-status-area");
    area.innerHTML = "";

    list.forEach(d => {
        const danger = d.stockQuantity <= d.minStock;

        area.innerHTML += `
            <div style="margin-bottom:10px;">
                <div>${d.name}</div>
                <div style="
                    height:6px;
                    background:#e5e7eb;
                    border-radius:4px;
                ">
                    <div style="
                        width:${Math.min(100, d.stockQuantity)}%;
                        height:100%;
                        background:${danger ? '#ef4444' : '#22c55e'};
                        border-radius:4px;
                    "></div>
                </div>
                <div style="font-size:12px; color:${danger ? 'red' : '#6b7280'};">
                    ${d.stockQuantity} ${d.unit}
                </div>
            </div>
        `;
    });
}

/* ---------------------------
   ğŸ’‰ ì²˜ì¹˜ ì¶”ê°€ / ë Œë”ë§
--------------------------- */
function addTreatment() {
    const type = document.getElementById("treatType").value;
    const name = document.getElementById("treatName").value.trim();
    const memo = document.getElementById("treatMemo").value.trim();

    if (!name) {
        alert("ì²˜ì¹˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }

    const item = { type, name, memo };
    treatmentList.push(item);
    renderTreatmentList();
}

function renderTreatmentList() {
    const area = document.getElementById("treatment-list");

    if (treatmentList.length === 0) {
        area.innerHTML = "ì²˜ì¹˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    area.innerHTML = "";
    treatmentList.forEach((t, idx) => {
        area.innerHTML += `
            <div style="padding:10px; background:white; border-radius:8px; margin-bottom:10px;">
                <strong>${t.type}</strong> - ${t.name}<br>
                <span style="color:#6b7280;">${t.memo || "-"}</span>
                <button onclick="deleteTreatment(${idx})"
                    style="float:right; margin-top:-25px; padding:4px 10px;
                           background:#ef4444; color:white; border:none;
                           border-radius:6px; cursor:pointer;">
                    ì‚­ì œ
                </button>
            </div>
        `;
    });
}

function deleteTreatment(idx) {
    treatmentList.splice(idx, 1);
    renderTreatmentList();
}

/* ---------------------------
   ğŸ”¥ ì „ì²´ ì €ì¥ (doctorId ìë™ ë°˜ì˜)
--------------------------- */
async function saveAll() {
    const visitId = sessionStorage.getItem("currentVisitId");

    if (!visitId) {
        alert("í˜„ì¬ ì„ íƒëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const body = {
        note: "",
        drugs: drugList,
        treatments: treatmentList
    };

    const res = await fetch(`/api/prescription/create?visitId=${visitId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    if (!res.ok) {
        const msg = await res.text();
        alert("ì €ì¥ ì‹¤íŒ¨!\n" + msg);
        return;
    }

    alert("ì²˜ë°©ì´ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}


/* ì²˜ìŒ ë“¤ì–´ì™”ì„ ë•Œ í™˜ì ì •ë³´ ë¡œë”© */
loadPatientInfo();
</script>
