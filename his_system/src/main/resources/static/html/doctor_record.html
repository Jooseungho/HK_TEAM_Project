<h2 style="font-size:26px; font-weight:700; margin-bottom:15px;">ì§„ë£Œ ê¸°ë¡</h2>

<div id="patient-info" style="margin-bottom:25px;"></div>

<!-- SOAP ì…ë ¥ ì˜ì—­ -->
<div style="background:white; padding:20px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.06);">

    <label>Subjective (í™˜ì í˜¸ì†Œ)</label>
    <textarea id="s" style="width:100%; height:80px; margin-bottom:15px;"></textarea>

    <label>Objective (ì˜ì‚¬ ê´€ì°°)</label>
    <textarea id="o" style="width:100%; height:80px; margin-bottom:15px;"></textarea>

    <label>Assessment (ì˜ì‚¬ íŒë‹¨)</label>
    <textarea id="a" style="width:100%; height:80px; margin-bottom:15px;"></textarea>

    <label>Plan (ì¹˜ë£Œ ê³„íš)</label>
    <textarea id="p" style="width:100%; height:80px; margin-bottom:25px;"></textarea>

    <label>ì§„ë‹¨ëª…</label>
    <input id="diagnosis" type="text" style="width:100%; padding:10px; margin-bottom:15px;">

    <label>ICD-10 ì½”ë“œ</label>
    <input id="icd" type="text" style="width:100%; padding:10px; margin-bottom:25px;">

    <button onclick="saveRecord()"
        style="width:100%; padding:15px; background:#2563eb; color:white; border:none;
               border-radius:12px; font-size:18px; cursor:pointer;">
        ì§„ë£Œ ì™„ë£Œ
    </button>
</div>

<script>
// -----------------------------------------------------
// ğŸ”µ í™˜ì ì •ë³´ + ìµœì‹  vital + ê³¼ê±° ì§„ë£Œ ë¡œë“œ
// -----------------------------------------------------
async function loadRecordPage() {

    if (!visitId) {
        alert("ì„ íƒëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const res = await fetch(`/api/visit/${visitId}/detail`);
    const data = await res.json();

    const visit = data.visit;
    const patient = data.patient;
    const vital = data.vital ?? {};

    document.getElementById("patient-info").innerHTML = `
        <div style="background:white; padding:20px; border-radius:12px;
                    box-shadow:0 3px 10px rgba(0,0,0,0.06); margin-bottom:20px;">
            <h3 style="margin-bottom:10px; font-size:20px;">${patient.name}</h3>
            <div>ì°¨íŠ¸ë²ˆí˜¸: ${patient.chartNo}</div>
            <div>ì„±ë³„: ${patient.gender} / ìƒë…„ì›”ì¼: ${patient.birthdate}</div>
            <div style="margin-top:10px; font-weight:700;">Vital Signs</div>
            <div>í˜ˆì••: ${vital.bpSystolic ?? '-'} / ${vital.bpDiastolic ?? '-'}</div>
            <div>ë§¥ë°•: ${vital.heartRate ?? '-'} bpm</div>
            <div>ì²´ì˜¨: ${vital.temperature ?? '-'} â„ƒ</div>
            <div style="margin-top:10px;">ì¦ìƒ: ${vital.memo ?? '-'}</div>
        </div>
    `;
}



// -----------------------------------------------------
// ğŸ”µ SOAP + ì§„ë‹¨ ì €ì¥ í›„ visit ìƒíƒœ DONE ì²˜ë¦¬
// -----------------------------------------------------
async function saveRecord() {

    const body = {
        visitId: visitId,
        subjective: document.getElementById("s").value,
        objective: document.getElementById("o").value,
        assessment: document.getElementById("a").value,
        plan: document.getElementById("p").value,
        diagnosis: document.getElementById("diagnosis").value,
        icdCode: document.getElementById("icd").value
    };

    // 1) SOAP ì €ì¥
    await fetch("/api/record/save", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
    });

    // 2) Visit â†’ ì™„ë£Œ ì²˜ë¦¬
    await fetch(`/api/visit/${visitId}/complete`, {
        method: "POST"
    });

    alert("ì§„ë£Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

    // âœ… í•µì‹¬: í˜„ì¬ ì§„ë£Œ í™˜ì ì œê±°
    sessionStorage.removeItem("currentVisitId");

    // âœ… ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
    location.href = "/html/doctor_dashboard.html";
}

// ì‹¤í–‰
loadRecordPage();
</script>