<h2 style="font-size:26px; font-weight:700; margin-bottom:10px;">ëŒ€ê¸° ì¤‘ì¸ í™˜ì</h2>
<p style="color:#6b7280; margin-bottom:25px;">
    ì´ <span id="waiting-count-text">0</span>ëª…ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.
</p>

<div id="waiting-list"></div>

<script>
// -----------------------------------------------------
// ğŸ”µ ëŒ€ê¸° í™˜ì ëª©ë¡ ë¡œë“œ
// -----------------------------------------------------
async function loadDoctorWaiting() {
    const res = await fetch("/api/visit/waiting_list");
    const list = await res.json();

    document.getElementById("waiting-count-text").innerText = list.length;

    const area = document.getElementById("waiting-list");
    area.innerHTML = "";

    list.forEach((item, idx) => {

        const p = item.patient ?? {};
        const v = item.vital ?? {};

        const name = p.name ?? "-";
        const chartNo = p.chartNo ?? "-";
        const time = item.arrivalTime ? item.arrivalTime.substring(11, 16) : "-";

        const bp = (v.bpSystolic && v.bpDiastolic)
            ? `${v.bpSystolic}/${v.bpDiastolic}`
            : "-";

        const pulse = v.heartRate ?? "-";
        const temp = v.temperature ?? "-";
        const symptom = v.memo ?? "-";

        area.innerHTML += `
            <div style="
                background:white;
                padding:25px;
                border-radius:14px;
                box-shadow:0 3px 10px rgba(0,0,0,0.06);
                margin-bottom:20px;
            ">

                <div style="display:flex; justify-content:space-between;">
                    <div style="display:flex; gap:15px;">
                        <div style="
                            background:#fde047;
                            padding:10px 18px;
                            border-radius:12px;
                            font-size:20px;
                            font-weight:700;
                        ">
                            ${idx + 1}
                        </div>

                        <div>
                            <div style="font-size:18px; font-weight:700;">${name}</div>
                            <div style="color:#6b7280; font-size:14px;">${chartNo}</div>
                            <div style="color:#6b7280; margin-top:4px;">â± ${time}</div>
                        </div>
                    </div>

                    <!-- ğŸ”µ í˜¸ì¶œ ë²„íŠ¼: callPatient() ì‹¤í–‰ -->
                    <button onclick="callPatient(${item.id})"
                        style="
                            background:#2563eb;
                            color:white;
                            border:none;
                            padding:10px 20px;
                            border-radius:10px;
                            font-size:16px;
                            cursor:pointer;
                        ">
                        í˜¸ì¶œ
                    </button>
                </div>

                <div style="
                    background:#f8fafc;
                    margin-top:20px;
                    padding:20px;
                    border-radius:12px;
                    display:flex;
                    justify-content:space-between;
                ">
                    <div>
                        <div style="font-weight:700;">í˜ˆì••</div>
                        <div>${bp}</div>
                    </div>
                    <div>
                        <div style="font-weight:700;">ë§¥ë°•</div>
                        <div>${pulse} bpm</div>
                    </div>
                    <div>
                        <div style="font-weight:700;">ì²´ì˜¨</div>
                        <div>${temp}â„ƒ</div>
                    </div>
                    <div>
                        <div style="font-weight:700;">ì¦ìƒ</div>
                        <div>${symptom}</div>
                    </div>
                </div>

            </div>
        `;
    });
}


// -----------------------------------------------------
// ğŸ”µ í™˜ì í˜¸ì¶œ(callPatient)
//    â†’ Visit ìƒíƒœ "IN_TREATMENT" ë¡œ ë³€ê²½
//    â†’ currentVisitId ì €ì¥
//    â†’ ì˜ì‚¬ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ í›„ #record íƒ­ ì‹¤í–‰
// -----------------------------------------------------
async function callPatient(visitId) {

    const doctorId = 1; // ë¡œê·¸ì¸ëœ ì˜ì‚¬ ID (ì„ì‹œ)

    const res = await fetch(`/api/visit/call/${visitId}/${doctorId}`, {
        method: "POST"
    });

    if (!res.ok) {
        alert("í™˜ì í˜¸ì¶œ ì‹¤íŒ¨!");
        return;
    }

    // ì„ íƒí•œ í™˜ì ì €ì¥
    sessionStorage.setItem("currentVisitId", visitId);

    // ê¸°ë¡ íƒ­ ìë™ ì‹¤í–‰
    location.href = "/html/doctor_dashboard.html#record";
}


// -----------------------------------------------------
// ğŸ”µ ì‹¤í–‰
// -----------------------------------------------------
loadDoctorWaiting();
</script>
