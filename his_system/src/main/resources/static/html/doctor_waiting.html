<h2 style="font-size:26px; font-weight:700; margin-bottom:10px;">
    ëŒ€ê¸° ì¤‘ì¸ í™˜ì
</h2>

<p style="color:#6b7280; margin-bottom:25px;">
    ì´ <span id="waiting-count-text">0</span>ëª…ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.
</p>

<div id="waiting-list"></div>

<script>
async function loadDoctorWaiting() {
    const res = await fetch("/api/visit/waiting_list");
    if (!res.ok) return;

    const list = await res.json();
    const area = document.getElementById("waiting-list");
    area.innerHTML = "";

    // ìƒíƒœ ë¶„ë¦¬
    const inTreatment = list.filter(
        v => v.status === "CALLED" || v.status === "IN_TREATMENT"
    );
    const waiting = list.filter(v => v.status === "WAITING");

    document.getElementById("waiting-count-text").innerText = waiting.length;

    // ğŸ”µ ì§„ë£Œ ì¤‘ í™˜ì (ë§¨ ìœ„)
    inTreatment.forEach(v => {
        area.innerHTML += renderVisit(v, true);
    });

    // ğŸŸ¡ ëŒ€ê¸° í™˜ì
    waiting.forEach((v, idx) => {
        area.innerHTML += renderVisit(v, false, idx);
    });
}

function renderVisit(item, isInTreatment, idx = 0) {

    const p = item.patient ?? {};
    const v = item.vital ?? {};

    const bg = isInTreatment ? "#eff6ff" : "white";
    const border = isInTreatment ? "1px solid #bfdbfe" : "none";
    const badgeText = isInTreatment ? "ì§„ë£Œ ì¤‘" : idx + 1;
    const badgeBg = isInTreatment ? "#2563eb" : "#fde047";
    const badgeColor = isInTreatment ? "white" : "black";

    const time = item.arrivalTime
        ? item.arrivalTime.substring(11, 16)
        : "-";

    const bp = (v.bpSystolic && v.bpDiastolic)
        ? `${v.bpSystolic}/${v.bpDiastolic}`
        : "-";

    return `
    <div style="
        background:${bg};
        padding:25px;
        border-radius:14px;
        margin-bottom:20px;
        box-shadow:0 3px 10px rgba(0,0,0,0.06);
        border:${border};
    ">
        <!-- ìƒë‹¨ ì˜ì—­ -->
        <div style="display:flex; align-items:center; gap:20px;">

            <!-- ğŸ”¥ ê³ ì • í­ ë±ƒì§€ -->
            <div style="
                width:64px;
                display:flex;
                justify-content:center;
            ">
                <div style="
                    width:48px;
                    height:48px;
                    border-radius:12px;
                    display:flex;
                    justify-content:center;
                    align-items:center;
                    font-size:16px;
                    font-weight:700;
                    background:${badgeBg};
                    color:${badgeColor};
                ">
                    ${badgeText}
                </div>
            </div>

            <!-- í™˜ì ì •ë³´ -->
            <div style="flex:1;">
                <div style="font-size:18px; font-weight:700;">
                    ${p.name ?? "-"}
                </div>
                <div style="color:#6b7280; font-size:14px;">
                    ${p.chartNo ?? "-"}
                </div>
                <div style="color:#6b7280; margin-top:4px;">
                    â± ${time}
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ë²„íŠ¼ / ìƒíƒœ -->
            <div style="margin-left:auto;">
                ${
                    isInTreatment
                        ? `<div style="color:#2563eb; font-weight:700;">ì§„ë£Œ ì¤‘</div>`
                        : `<button onclick="callPatient(${item.id})"
                            style="
                                background:#2563eb;
                                color:white;
                                border:none;
                                padding:10px 20px;
                                border-radius:10px;
                                font-size:16px;
                                cursor:pointer;
                            ">
                            í˜¸ì¶œ
                          </button>`
                }
            </div>
        </div>

        <!-- í•˜ë‹¨ ë°”ì´íƒˆ -->
        <div style="
            background:#f8fafc;
            margin-top:20px;
            padding:20px;
            border-radius:12px;
            display:flex;
            justify-content:space-between;
        ">
            <div>
                <div style="font-weight:700;">í˜ˆì••</div>
                <div>${bp}</div>
            </div>
            <div>
                <div style="font-weight:700;">ë§¥ë°•</div>
                <div>${v.heartRate ?? "-"} bpm</div>
            </div>
            <div>
                <div style="font-weight:700;">ì²´ì˜¨</div>
                <div>${v.temperature ?? "-"} â„ƒ</div>
            </div>
            <div>
                <div style="font-weight:700;">ì¦ìƒ</div>
                <div>${v.memo ?? "-"}</div>
            </div>
        </div>
    </div>
    `;
}

async function callPatient(visitId) {
    const res = await fetch(`/api/visit/call/${visitId}`, {
        method: "POST"
    });

    if (!res.ok) {
        alert("í™˜ì í˜¸ì¶œ ì‹¤íŒ¨!");
        return;
    }

    sessionStorage.setItem("currentVisitId", visitId);

    // ì¦‰ì‹œ ê°±ì‹ 
    loadDoctorWaiting();
}

loadDoctorWaiting();
</script>
