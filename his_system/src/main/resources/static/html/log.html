<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œìŠ¤í…œ ë¡œê·¸</title>

    <!-- ğŸ” ê´€ë¦¬ì ì ‘ê·¼ ì œì–´ -->
    <script src="/js/access.js"></script>
    <script src="/js/app.js"></script>

    <style>
        body {
            font-family: Pretendard, sans-serif;
            background: #f8f9fb;
            margin: 0;
        }

        .header {
            background: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .title { font-size: 20px; font-weight: 700; }

        .summary-boxes {
            display: flex;
            gap: 20px;
            padding: 20px 30px;
        }
        .box {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .box-title { font-size: 15px; color: #555; }
        .box-value { margin-top: 8px; font-size: 28px; font-weight: 700; }

        .menu {
            display: flex;
            gap: 20px;
            padding: 0 30px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }
        .menu a {
            padding: 15px 5px;
            font-size: 16px;
            color: #555;
            text-decoration: none;
        }
        .menu a.active {
            font-weight: 700;
            border-bottom: 3px solid #6b50ff;
            color: #6b50ff;
        }

        .content { padding: 25px 30px; }

        .filter-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-box input,
        .filter-box select,
        .filter-box button {
            padding: 8px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        th {
            background: #f3f4f6;
            padding: 12px;
            font-size: 14px;
            text-align: center;
        }
        td {
            padding: 12px;
            border-top: 1px solid #eee;
            font-size: 14px;
            text-align: center;
        }

        .pagination { margin-top: 20px; text-align: center; }
        .pagination button {
            padding: 6px 12px;
            margin: 0 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<!-- ===== í—¤ë” ===== -->
<div class="header">
    <div class="title">ê´€ë¦¬ì ì‹œìŠ¤í…œ</div>
    <div style="display:flex; gap:15px; align-items:center;">
        <div id="admin-name"></div>
        <button class="btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- ===== ìš”ì•½ ===== -->
<div class="summary-boxes">
    <div class="box">
        <div class="box-title">ë¡œê·¸ì¸</div>
        <div class="box-value" id="loginCount">0íšŒ</div>
    </div>
    <div class="box">
        <div class="box-title">ë¡œê·¸ì•„ì›ƒ</div>
        <div class="box-value" id="logoutCount">0íšŒ</div>
    </div>
    <div class="box">
        <div class="box-title">EMR ì¡°íšŒ</div>
        <div class="box-value" id="emrViewCount">0ê±´</div>
    </div>
</div>

<!-- ===== ë©”ë‰´ ===== -->
<div class="menu">
    <a href="/html/admin_dashboard.html">ê³„ì • ê´€ë¦¬</a>
    <a class="active">ì‹œìŠ¤í…œ ë¡œê·¸</a>
    <a href="/html/inventory.html">ì¬ê³  ê´€ë¦¬</a>
</div>

<!-- ===== ë³¸ë¬¸ ===== -->
<div class="content">

    <!-- ê²€ìƒ‰/í•„í„° -->
    <div class="filter-box">
        <input type="text" id="employeeNo" placeholder="ì§ì›ë²ˆí˜¸">
        <select id="actionType">
            <option value="">ì „ì²´ ì‘ì—…</option>
            <option value="LOGIN">ë¡œê·¸ì¸</option>
            <option value="LOGOUT">ë¡œê·¸ì•„ì›ƒ</option>
            <option value="EMR_VIEW">EMR ì¡°íšŒ</option>
            <option value="PATIENT_REGISTER">í™˜ì ì ‘ìˆ˜</option>
            <option value="DOCUMENT_ISSUE">ë¬¸ì„œ ë°œí–‰</option>
        </select>
        <input type="datetime-local" id="from">
        <input type="datetime-local" id="to">
        <button onclick="loadLogs(0)">ê²€ìƒ‰</button>
    </div>

    <!-- ë¡œê·¸ í…Œì´ë¸” -->
    <table>
        <thead>
        <tr>
            <th>ì‹œê°„</th>
            <th>ì‚¬ìš©ì</th>
            <th>ì‘ì—…</th>
            <th>ëŒ€ìƒ ID</th>
            <th>ì„¸ë¶€ì‚¬í•­</th>
        </tr>
        </thead>
        <tbody id="logTableBody"></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
</div>

<script>
/* ê´€ë¦¬ì ê¶Œí•œ + ì´ë¦„ */
checkAccess(["ADMIN"]);

const name = localStorage.getItem("name");
if (name) {
    document.getElementById("admin-name").innerText = `${name} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
}

/* ===== ë¡œê·¸ ë¡œë”© ===== */
async function loadLogs(page) {
    const employeeNo = document.getElementById("employeeNo").value;
    const actionType = document.getElementById("actionType").value;
    const from = document.getElementById("from").value;
    const to = document.getElementById("to").value;

    const params = new URLSearchParams({ page, size: 10 });
    if (employeeNo) params.append("employeeNo", employeeNo);
    if (actionType) params.append("actionType", actionType);
    if (from) params.append("from", from);
    if (to) params.append("to", to);

    const res = await fetch(`/api/admin/system-logs?${params.toString()}`);
    const data = await res.json();

    const tbody = document.getElementById("logTableBody");
    tbody.innerHTML = "";

    const rows = data.content ?? data;

    let loginCnt = 0, logoutCnt = 0, emrCnt = 0;

    rows.forEach(log => {
        if (log.actionType === "LOGIN") loginCnt++;
        if (log.actionType === "LOGOUT") logoutCnt++;
        if (log.actionType === "EMR_VIEW") emrCnt++;

        tbody.innerHTML += `
            <tr>
                <td>${log.createdAt}</td>
                <td>${log.staffName} (${log.employeeNo})</td>
                <td>${log.actionType}</td>
                <td>${log.targetId ?? ""}</td>
                <td>${log.description}</td>
            </tr>
        `;
    });

    document.getElementById("loginCount").innerText = `${loginCnt}íšŒ`;
    document.getElementById("logoutCount").innerText = `${logoutCnt}íšŒ`;
    document.getElementById("emrViewCount").innerText = `${emrCnt}ê±´`;

    renderPagination(data);
}

/* í˜ì´ì§€ë„¤ì´ì…˜ */
function renderPagination(data) {
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    if (!data.totalPages) return;

    for (let i = 0; i < data.totalPages; i++) {
        container.innerHTML += `<button onclick="loadLogs(${i})">${i + 1}</button>`;
    }
}

window.addEventListener("DOMContentLoaded", () => loadLogs(0));
</script>

</body>
</html>
